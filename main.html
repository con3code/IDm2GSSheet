<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>IDm2GSSheet - con3office</title>
    <base href ="https://con3.com/files/">
    <meta name="twitter:title" content="IDm2GSSheet - con3office">
    <meta property="og:description" content="Felica IDm 2 Google SpreadSheet; with PaSoRi">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="og:image" content="assets/img/ScreenShot%2020210416_222338@2x.png">
    <meta name="twitter:image" content="assets/img/ScreenShot%2020210416_222338@2x.png">
    <meta property="og:type" content="website">
    <meta name="description" content="Felica IDm 2 Google SpreadSheet; with PaSoRi">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/fontawesome5-overrides.min.css">
</head>

<body id="page-top">
    <div id="wrapper">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0" style="background: var(--blue);">
            <div class="container-fluid d-flex flex-column p-0"><a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0">
                    <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-laugh-wink"></i></div>
                    <div class="sidebar-brand-text mx-3"><span>IDm2GSSheet</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link" href="https://con3.com/sc2scratch/" target="_blank"><i class="fa fa-home"></i><span>sc2scratch</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="https://docs.google.com/spreadsheets/" target="_blank"><i class="fa fa-th-list"></i><span>GSSheet</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="https://www.labelyasan.com" target="_blank"><i class="fa fa-pencil-square-o"></i><span>ラベル屋さん<br></span></a></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                    <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle mr-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button>
                        <div class="alert alert-warning" role="alert" style="margin-top: 16px;"><span><strong>このサイトはWebUSB対応ブラウザ（Google Chrome）とICカードリーダーSONY RC-S380（PaSoRi）が必要です</strong><br></span></div>
                    </div>
                </nav>
                <div class="row">
                    <div class="col-lg-7">
                        <div class="container-fluid">
                            <h2 class="mb-1" style="font-weight: bold;color: var(--blue);">Felica IDm を GSSheet へ</h2>
                            <div style="margin-bottom: 38px;margin-top: 20px;width: 500px;">
                                <p>URLの"https://docs.google.com/spreadsheets/d/"と"/"で挟まれた部分が<strong>スプレッドシートID</strong>です。</p>
                            </div>
                            <div class="card" style="width: 500px;">
                                <div class="card-body">
                                    <div><label style="margin-right: 10px;">Google スプレッドシートID</label></div>
                                    <div style="margin-bottom: 8px;"><input type="text" id="sheetid" style="width: 460px;" name="sheetid"></div>
                                    <div><label style="margin-right: 4px;">シート名</label><input type="text" id="sheet_name" style="width: 100px;margin-right: 10px;" value="シート1"><label style="margin-right: 4px;">確認列No</label><input type="number" id="name_column" style="width: 60px;margin-right: 10px;" value="1"><label style="margin-right: 4px;">記録列No</label><input type="number" id="write_column" style="width: 60px;" value="2"></div>
                                    <div style="margin-top: 16px;"><button class="btn btn-info" type="button" onclick="callSetting()">設定</button><span class="text-danger" id="setting_disp" style="margin-left: 12px;"><?=setting_disp ?></span></div>
                                </div>
                            </div>
                            <div class="card" style="width: 500px;margin-top: 30px;margin-bottom: 50px;">
                                <div class="card-header">
                                    <h5 class="mb-0">読み取り＆記録</h5>
                                </div>
                                <div class="card-body">
                                    <div>
                                        <p>PaSoRiでFeliCaのIDmを読み取り、指定行に記録します。</p>
                                    </div>
                                    <div><input class="form-control-lg" type="number" id="row_input" style="margin-top: auto;margin-bottom: auto;width: 100px;font-size: 24px;" onclick="setInput2RowRenge()"><input type="range" id="row_renge" style="margin-right: 18px;margin-left: 12px;height: 10px;" onclick="setRenge2RowInput()"><span id="name_disp" style="font-size: 24px;color: rgb(0, 0, 0);font-weight: bold;"><?=name_disp ?></span></div>
                                    <div style="margin-top: 16px;">
                                        <div><button class="btn btn-primary" id="start" type="button" style="width: 460px;">PaSoRiで読み取り</button></div>
                                        <div><button class="btn btn-primary" id="waiting" type="button" style="display:none;width: 460px;" onclick="stopEvent()">PaSoRiにカードをかざしてください<span class="spinner-border spinner-border-sm" role="status" style="margin-bottom: 4px;margin-left: 8px;"></span></button></div>
                                        <div><button class="btn btn-outline-primary" id="idm" type="button" style="width: 460px;display: none;"></button></div>
                                    </div>
                                    <div class="text-right" style="margin-top: 20px;"><button class="btn btn-danger" id="regist" type="button" onclick="callWrite()" style="width: 80px;">記録</button></div>
                                    <div><span></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col" style="margin-right: 28px;">
                        <div class="container">
                            <h4 style="font-weight: bold;color: var(--primary);">IDm2GSSheetとは</h4>
                            <p>FelicaカードのIDmをGoogleスプレッドシート（GSSheet）に記録するツールです。QRコード生成などに使えます。<br><br>【使い方】<br>このサイトはChromeブラウザ（WebUSB対応ブラウザ）での利用が必要です。<br><br>1) 記録したいGSSheetで使用しているのと同じアカウントでこのサイトを開き、SC2QRによるアクセス許可の認証を行なっていること。<br><br>2) GSSheetに記録用スプレッドシートを作成し、名簿など入力しておく（最初の1行目は列ラベル）。<br><br>3) スプレッドシートIDを入力欄にコピペする。<br><br>4) シート名、列番号などを入力したら［設定］ボタンを押して記録するシートをセットする。<br><br>5) ［PaSoRiで読み取り］で読み取り開始（初めはデバイス選択メニューがでることがある）。もう一度クリックで読み取り停止。<br><br>6) シートの記録したい行数を選ぶ。<br><br>7) ［記録］でIDmを記録し、自動的に次の行へ。<br><br>8) GSSheetを開いて確認しながら作業できます。</p>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright ©con3office 2021</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>

<script>

let startButton = document.getElementById('start');
let idmMessage = document.getElementById('idm');
let waitingMessage = document.getElementById('waiting');
let nameDisp = document.getElementById('name_disp');
let settingDisp = document.getElementById('setting_disp');
let sheetId = document.getElementById('sheetid');
let rowInput = document.getElementById('row_input');
let rowRenge = document.getElementById('row_renge');
let sheetName = document.getElementById('sheet_name');
let nameColumn = document.getElementById('name_column');
let writeColumn = document.getElementById('write_column');
let pasori;
let idmString ='';
let readingFlag = false;
let waitingFlag = true;
let rowPointer = 1;
let minRows = 1;
let maxRows = 100;
let autoReadFlag = false;
let settingDoneFlag = false;
let spreadsheetId;
let sheetNameNo;
let nameColumnNo;
let writeColumnNo;


function callSetting(){
    spreadsheetId = sheetId.value;
    sheetNameNo = sheetName.value;
    nameColumnNo = nameColumn.value;
    writeColumnNo = writeColumn.value;
    google.script.run.withSuccessHandler(backSetting).doSetting(spreadsheetId, sheetNameNo);    
    
}

function backSetting(max){
    rowRenge.min = minRows;
    rowRenge.max = maxRows = max;
    rowPointer = rowInput.value = rowRenge.value = 2;
    settingDoneFlag = true;
    settingDisp.innerText = 'シート設定完了';
    callName();
}


function callName() {
    if(settingDoneFlag){
        stopEvent();
        nameDisp.innerText = '…';
        google.script.run.withSuccessHandler(backName).doName(spreadsheetId, sheetNameNo, nameColumnNo, rowPointer);
    }    
}
    

function backName(res) {
    console.log('Name:' + res);
    nameDisp.innerText = res; 
}



function callWrite() {
    if (settingDoneFlag && !waitingFlag){
        stopEvent();
        google.script.run.withSuccessHandler(backWrite).doWrite(spreadsheetId, sheetNameNo, writeColumnNo, rowPointer,idmString);        
    }    
}
    

function backWrite(res) {
    //nameDisp.innerText = res;
    let rp = Number.parseInt(rowPointer);
    if(rp < maxRows && rp > 0){
        rowPointer = rowInput.value = rowRenge.value = rp + 1;
    } else {
        if(rp > maxRows/2){
            rowPointer = rowInput.value = rowRenge.value = rp + 1;            
        } else {
            rowPointer = rowInput.value = rowRenge.value = 1;
        }
    }
    callName();
    actRead();        
}



function setRenge2RowInput(){
    if(rowRenge.value <= maxRows && rowRenge.value > 0){
        rowPointer = rowInput.value = rowRenge.value;
        if(settingDoneFlag){
            callName();        
        }
    }else{
        if(rowRenge.value > maxRows/2){
            rowPointer = rowInput.value = rowRenge.value = maxRows;        
        } else {
            rowPointer = rowInput.value = rowRenge.value = 1;
        }
        if(settingDoneFlag){
            callName();        
        }
    }
}

function setInput2RowRenge(){
    if(rowInput.value <= maxRows && rowInput.value > 0){
        rowPointer = rowRenge.value = rowInput.value;
        if(settingDoneFlag){
            callName();        
        }
    } else {
        if(rowInput.value > maxRows/2){
            rowPointer = rowRenge.value = rowInput.value = maxRows;        
        } else {
            rowPointer = rowRenge.value = rowInput.value = 1;        
        }
        if(settingDoneFlag){
            callName();        
        }
    }
}



async function sleep(msec) {
  return new Promise(resolve => setTimeout(resolve, msec));
}

async function send(device, data) {
  let uint8a = new Uint8Array(data);
  console.log(">>>>>>>>>>");
//  console.log(uint8a);
  await device.transferOut(2, uint8a);
  await sleep(10);
}

async function receive(device, len) {
  console.log("<<<<<<<<<<" + len);
  let data = await device.transferIn(1, len);
  console.log(data);
  await sleep(10);
  let arr = [];
  for (let i = data.data.byteOffset; i < data.data.byteLength; i++) {
    arr.push(data.data.getUint8(i));
  }
//  console.log(arr);
  return arr;
}

async function session(device) {

  await send(device, [0x00, 0x00, 0xff, 0x00, 0xff, 0x00]);

  await send(device, [0x00, 0x00, 0xff, 0xff, 0xff, 0x03, 0x00, 0xfd, 0xd6, 0x2a, 0x01, 0xff, 0x00]);
  await receive(device, 6);
  await receive(device, 13);

  await send(device, [0x00, 0x00, 0xff, 0xff, 0xff, 0x03, 0x00, 0xfd, 0xd6, 0x06, 0x00, 0x24, 0x00]);
  await receive(device, 6);
  await receive(device, 13);

  await send(device, [0x00, 0x00, 0xff, 0xff, 0xff, 0x03, 0x00, 0xfd, 0xd6, 0x06, 0x00, 0x24, 0x00]);
  await receive(device, 6);
  await receive(device, 13);

  await send(device, [0x00, 0x00, 0xff, 0xff, 0xff, 0x06, 0x00, 0xfa, 0xd6, 0x00, 0x01, 0x01, 0x0f, 0x01, 0x18, 0x00]);
  await receive(device, 6);
  await receive(device, 13);

  await send(device, [0x00, 0x00, 0xff, 0xff, 0xff, 0x28, 0x00, 0xd8, 0xd6, 0x02, 0x00, 0x18, 0x01, 0x01, 0x02, 0x01, 0x03, 0x00, 0x04, 0x00, 0x05, 0x00, 0x06, 0x00, 0x07, 0x08, 0x08, 0x00, 0x09, 0x00, 0x0a, 0x00, 0x0b, 0x00, 0x0c, 0x00, 0x0e, 0x04, 0x0f, 0x00, 0x10, 0x00, 0x11, 0x00, 0x12, 0x00, 0x13, 0x06, 0x4b, 0x00]);
  await receive(device, 6);
  await receive(device, 13);

  await send(device, [0x00, 0x00, 0xff, 0xff, 0xff, 0x04, 0x00, 0xfc, 0xd6, 0x02, 0x00, 0x18, 0x10, 0x00]);
  await receive(device, 6);
  await receive(device, 13);

  await send(device, [0x00, 0x00, 0xff, 0xff, 0xff, 0x0a, 0x00, 0xf6, 0xd6, 0x04, 0x6e, 0x00, 0x06, 0x00, 0xff, 0xff, 0x01, 0x00, 0xb3, 0x00]);
  await receive(device, 6);

  let idm = (await receive(device, 37)).slice(17, 25);
    if (idm.length > 0) {
        waitingFlag = false;
        let idmStr = '';
        for (let i = 0; i < idm.length; i++) {
            if (idm[i] < 16) {
                idmStr += '0';
            }
            idmStr += idm[i].toString(16);
        }
        idmString = idmStr;
        idmMessage.innerText = "カードのIDm: " + idmStr;
        idmMessage.style.display = 'block';
        waitingMessage.style.display = 'none';
    } else {
        waitingFlag = true;
        idmMessage.style.display = 'none';
        waitingMessage.style.display = 'block';
    }
    
    if(!readingFlag){
        waitingMessage.style.display = 'none';
        idmMessage.style.display = 'none';
        startButton.style.display = 'block';
    }

}


function stopEvent(){
    readingFlag = false;
    waitingMessage.style.display = 'none';
    idmMessage.style.display = 'none';
    startButton.style.display = 'block';    
}


async function actRead(){
    readingFlag = true;

    try {
        console.log("selectConfiguration");
        await pasori.selectConfiguration(1);
        console.log("claimInterface");
        await pasori.claimInterface(0);
        console.log(pasori);
        startButton.style.display = 'none';
        waitingMessage.style.display = 'block';

        do {
            await session(pasori);
            await sleep(500);
        } while (readingFlag);

    } catch (e) {
        console.log(e);
        alert(e);
        try {
            pasori.close();
        } catch (e) {
            console.log(e);
        }
        waitingMessage.style.display = 'none';
        idmMessage.style.display = 'none';
        startButton.style.display = 'block';
        throw e;
    }

}

idmMessage.addEventListener('click', async () => {
    idmMessage.style.display = 'none';
    waitingMessage.style.display = 'none';
    stopEvent();

//    readingFlag = true;
//    actRead();
});

startButton.addEventListener('click', async () => {

    if(pasori == undefined){
        
        try {
             pasori = await navigator.usb.requestDevice({ filters:[{vendorId: 0x054c}] });
            console.log("open");
            await pasori.open();
        } catch (e) {
            console.log(e);
            alert(e);
            throw e;
        }
        
    }
    
    actRead();

});
</script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.js"></script>
    <script src="assets/js/theme.js"></script>
</body>

</html>
